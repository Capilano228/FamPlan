<?php
session_start();

// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (!isset($_SESSION['user_id'])) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    include 'login_form.php';
    exit;
}

// –ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
function generateSimpleCalendar($year, $month) {
    $firstDay = date('N', strtotime("$year-$month-01"));
    $daysInMonth = date('t', strtotime("$year-$month-01"));
    
    $monthNames = [
        1 => '–Ø–Ω–≤–∞—Ä—å', 2 => '–§–µ–≤—Ä–∞–ª—å', 3 => '–ú–∞—Ä—Ç', 
        4 => '–ê–ø—Ä–µ–ª—å', 5 => '–ú–∞–π', 6 => '–ò—é–Ω—å',
        7 => '–ò—é–ª—å', 8 => '–ê–≤–≥—É—Å—Ç', 9 => '–°–µ–Ω—Ç—è–±—Ä—å',
        10 => '–û–∫—Ç—è–±—Ä—å', 11 => '–ù–æ—è–±—Ä—å', 12 => '–î–µ–∫–∞–±—Ä—å'
    ];
    
    $days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    
    $calendar = '<div class="calendar-grid">';
    
    foreach ($days as $day) {
        $calendar .= '<div class="calendar-day-header">' . $day . '</div>';
    }
    
    for ($i = 1; $i < $firstDay; $i++) {
        $calendar .= '<div class="calendar-day empty"></div>';
    }
    
    for ($day = 1; $day <= $daysInMonth; $day++) {
        $date = sprintf('%04d-%02d-%02d', $year, $month, $day);
        $isToday = ($date == date('Y-m-d'));
        
        $class = 'calendar-day';
        if ($isToday) $class .= ' today';
        
        $calendar .= '<div class="' . $class . '" data-date="' . $date . '">';
        $calendar .= '<div class="day-number">' . $day . '</div>';
        $calendar .= '</div>';
    }
    
    $calendar .= '</div>';
    return $calendar;
}

// –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
$currentMonth = date('m');
$currentYear = date('Y');
$calendar_html = generateSimpleCalendar($currentYear, $currentMonth);

// –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$username = $_SESSION['username'] ?? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
$role = $_SESSION['role'] ?? 'child';
?>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamPlan ‚Ä¢ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-sidebar">
                    <div class="logo-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <h2>FamPlan</h2>
                </div>
                <div class="user-info">
                    <div class="user-avatar" style="background: #A8D8EA;">
                        <?php echo $role === 'parent' ? 'üëë' : 'üåü'; ?>
                    </div>
                    <div class="user-details">
                        <h3><?php echo htmlspecialchars($username); ?></h3>
                        <span class="user-role"><?php echo $role === 'parent' ? 'üëë –†–æ–¥–∏—Ç–µ–ª—å' : 'üåü –†–µ–±–µ–Ω–æ–∫'; ?></span>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span>–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="#calendar" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                </a>
                <a href="#checklists" class="nav-item">
                    <i class="fas fa-tasks"></i>
                    <span>–ß–µ–∫-–ª–∏—Å—Ç—ã</span>
                </a>
                <a href="#chat" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>–ß–∞—Ç</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <form method="POST" action="logout.php">
                    <button type="submit" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </button>
                </form>
            </div>
        </aside>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-left">
                    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
                    <p class="greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <?php echo htmlspecialchars($username); ?>!</p>
                </div>
                <div class="header-right">
                    <div class="date-display">
                        <i class="fas fa-calendar-day"></i>
                        <span><?php echo date('d.m.Y'); ?></span>
                    </div>
                </div>
            </header>
            
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <section id="dashboard" class="content-section active">
                <div class="calendar-widget">
                    <div class="calendar-header">
                        <h3><?php 
                            $monthNames = [
                                1 => '–Ø–Ω–≤–∞—Ä—å', 2 => '–§–µ–≤—Ä–∞–ª—å', 3 => '–ú–∞—Ä—Ç', 
                                4 => '–ê–ø—Ä–µ–ª—å', 5 => '–ú–∞–π', 6 => '–ò—é–Ω—å',
                                7 => '–ò—é–ª—å', 8 => '–ê–≤–≥—É—Å—Ç', 9 => '–°–µ–Ω—Ç—è–±—Ä—å',
                                10 => '–û–∫—Ç—è–±—Ä—å', 11 => '–ù–æ—è–±—Ä—å', 12 => '–î–µ–∫–∞–±—Ä—å'
                            ];
                            echo $monthNames[(int)$currentMonth] . ' ' . $currentYear;
                        ?></h3>
                    </div>
                    <?php echo $calendar_html; ?>
                </div>
            </section>
        </main>
    </div>
    
    <script src="script.js"></script>
</body>
</html>